"use strict";(()=>{var e={};e.id=355,e.ids=[355],e.modules={2081:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>p,serverHooks:()=>b,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>E});var a={};t.r(a),t.d(a,{GET:()=>l,POST:()=>f});var i=t(96559),o=t(48088),n=t(37719),s=t(32190),d=t(13641),c=t(48719),u=t(8516);async function f(e){try{let{title:r,author:t,nickname:a,openDate:i,number:o,englishDescription:n,hintImageUrl:f,hintText:l,imageCover:p,codeText:_,isSecret:E,code:b,content:h,memoryPhoto:x}=await e.json();if(!i||!o||!n)return s.NextResponse.json({error:"openDate, number, and englishDescription are required"},{status:400});if(await d.db.gift.findUnique({where:{number:o}}))return s.NextResponse.json({error:"Gift with this number already exists"},{status:400});let A=await (0,c.or)(Math.random().toString(36).substring(7)),g=await d.db.gift.create({data:{title:r,author:t||"",nickname:a||"",openDate:new Date(i),number:o,englishDescription:n,hintImageUrl:f||"",imageCover:p||null,hintText:l??"look for a gift with this sticker",codeText:_??"This is the part of your cipher. Collect them all to reveal the last secret",contentPath:A,isSecret:E??!1,code:b}}),w=await (0,c.or)(g.id);if(await d.db.gift.update({where:{id:g.id},data:{contentPath:w}}),h){if(!await (0,c.z_)(g.id,h))return await d.db.gift.delete({where:{id:g.id}}),s.NextResponse.json({error:"Failed to save gift content"},{status:500});if(u._.YANDEX_ACCESS_KEY_ID&&u._.YANDEX_SECRET_ACCESS_KEY&&u._.YANDEX_BUCKET_NAME){let e=`https://${u._.YANDEX_BUCKET_NAME}.storage.yandexcloud.net/${g.id}_content.json`;await d.db.gift.update({where:{id:g.id},data:{contentUrl:e}})}}else if(await (0,c.z_)(g.id,{blocks:[],metadata:{senderName:"",description:"С днем рождения!"}}),u._.YANDEX_ACCESS_KEY_ID&&u._.YANDEX_SECRET_ACCESS_KEY&&u._.YANDEX_BUCKET_NAME){let e=`https://${u._.YANDEX_BUCKET_NAME}.storage.yandexcloud.net/${g.id}_content.json`;await d.db.gift.update({where:{id:g.id},data:{contentUrl:e}})}x?.photoUrl&&await d.db.memoryPhoto.create({data:{photoUrl:x.photoUrl,giftId:g.id}});let C=await d.db.gift.findUnique({where:{id:g.id},include:{memoryPhoto:{include:{gift:!0}}}});return s.NextResponse.json(C,{status:201})}catch(e){return console.error("Error creating gift:",e),s.NextResponse.json({error:"Failed to create gift"},{status:500})}}async function l(){try{let e=await d.db.gift.findMany({include:{memoryPhoto:{include:{gift:!0}}},orderBy:{openDate:"desc"}});return s.NextResponse.json(e)}catch(e){return console.error("Error fetching gifts:",e),s.NextResponse.json({error:"Failed to fetch gifts"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/gifts/route",pathname:"/api/gifts",filename:"route",bundlePath:"app/api/gifts/route"},resolvedPagePath:"C:\\repositories\\lesya.svet\\src\\app\\api\\gifts\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:_,workUnitAsyncStorage:E,serverHooks:b}=p;function h(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:E})}},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},13641:(e,r,t)=>{t.d(r,{db:()=>n});var a=t(96330),i=t(8516);let o=globalThis,n=o.prisma??new a.PrismaClient({log:"development"===i._.NODE_ENV?["query","error","warn"]:["error"]});"production"!==i._.NODE_ENV&&(o.prisma=n)},19185:e=>{e.exports=require("dgram")},21820:e=>{e.exports=require("os")},21994:e=>{e.exports=require("domain")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48719:(e,r,t)=>{t.d(r,{Tu:()=>C,jJ:()=>A,or:()=>h,q2:()=>x,ql:()=>g,qr:()=>_,xK:()=>l,xZ:()=>w,ys:()=>p,z2:()=>b,z_:()=>E});var a=t(67218);t(79130);var i=t(29021),o=t(33873),n=t.n(o),s=t(82162),d=t(8516);let c=n().join(process.cwd(),"static","gifts");function u(e){return n().join(c,e)}function f(e){return n().join(u(e),"content.json")}let l=async function(e){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME){let r=await (0,s.yk)(e);if(r)return r}let r=f(e),t=await i.promises.readFile(r,"utf-8");return JSON.parse(t)}catch(r){return console.error(`Ошибка загрузки контента подарка: ${e}`,r),null}};var p=(0,a.A)(l,"406d5606aead8a8bacfe2cdd3e85cfdd2c19db2000",null);let _=async function(e,r){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME)try{return await (0,s.yz)(e,r),!0}catch(r){console.error(`Ошибка сохранения контента в Yandex Object Storage: ${e}`,r)}let t=u(e),a=f(e);return await i.promises.mkdir(t,{recursive:!0}),await i.promises.writeFile(a,JSON.stringify(r,null,2),"utf-8"),!0}catch(r){return console.error(`Ошибка сохранения контента подарка: ${e}`,r),!1}};var E=(0,a.A)(_,"60b232e31a3e4489582c571d7d7610ac8bf38a305a",null);let b=async function(e){return e};var h=(0,a.A)(b,"40dbb6530b043238ae6a08c39b3c8036d234882809",null);let x=async function(e){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME&&await (0,s.T1)(e))return!0;let r=f(e);return await i.promises.access(r),!0}catch{return!1}};(0,a.A)(x,"40ca065a4463e8263867e3e499283bc6b495df367f",null);let A=async function(e,r,t,a){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME)return await (0,s.TU)(t,r,e,a);throw Error("Yandex Object Storage is not configured")}catch(t){throw console.error(`Ошибка сохранения файла ${r} для подарка ${e}:`,t),t}};(0,a.A)(A,"78b96f14216dbd9b99266f83758b0d01a4b1b85f54",null);let g=async function(e,r){try{let t=r?n().join(u(e),r):u(e);return(await i.promises.readdir(t)).filter(e=>!e.startsWith("."))}catch(r){return console.error(`Ошибка получения файлов подарка ${e}:`,r),[]}};(0,a.A)(g,"600a0d7df77d62b52c417650c18d18495bacd7d9b8",null);let w=async function(e){try{let r=u(e);return await i.promises.rm(r,{recursive:!0,force:!0}),!0}catch(r){return console.error(`Ошибка удаления папки подарка ${e}:`,r),!1}};var C=(0,a.A)(w,"401a0502c0665f669338aad34b336a2135500fe412",null)},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},94735:e=>{e.exports=require("events")},95795:(e,r,t)=>{t.r(r),t.d(r,{"00ea83477a13a459fdf08fd3e6f65958e8233576fd":()=>i.xK,"401a0502c0665f669338aad34b336a2135500fe412":()=>a.xZ,"40217cf8d08e1947972106ddde22ddf43c2bb0ed41":()=>i.z2,"4066d672de5ab4d947483099099b587b8f65bca2a7":()=>i.q2,"406d0e21608895f9fa266a4fd00f7cd6825119033a":()=>i.EB,"406d5606aead8a8bacfe2cdd3e85cfdd2c19db2000":()=>a.xK,"4078492ea5b92d5fdfeed6743137880623145f68ac":()=>i.xZ,"40ca065a4463e8263867e3e499283bc6b495df367f":()=>a.q2,"40dbb6530b043238ae6a08c39b3c8036d234882809":()=>a.z2,"600a0d7df77d62b52c417650c18d18495bacd7d9b8":()=>a.ql,"60104488d5035fa6645db34d4720bc5db5ca51ebe3":()=>i.jJ,"6065a8450153a035b58e5f7c83c86ece5b2a923f4b":()=>i.ql,"60b232e31a3e4489582c571d7d7610ac8bf38a305a":()=>a.qr,"783346ae271af48396c519dd51d41fc3ec639e216f":()=>i.qr,"78b96f14216dbd9b99266f83758b0d01a4b1b85f54":()=>a.jJ});var a=t(48719),i=t(82162)},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[447,724,267,580,41],()=>t(2081));module.exports=a})();