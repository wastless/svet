"use strict";(()=>{var e={};e.id=495,e.ids=[495],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},13641:(e,r,t)=>{t.d(r,{db:()=>i});var o=t(96330),a=t(8516);let n=globalThis,i=n.prisma??new o.PrismaClient({log:"development"===a._.NODE_ENV?["query","error","warn"]:["error"]});"production"!==a._.NODE_ENV&&(n.prisma=i)},19185:e=>{e.exports=require("dgram")},21820:e=>{e.exports=require("os")},21994:e=>{e.exports=require("domain")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},41204:e=>{e.exports=require("string_decoder")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45576:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>m,routeModule:()=>_,serverHooks:()=>x,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>h});var o={};t.r(o),t.d(o,{DELETE:()=>E,GET:()=>l,PUT:()=>p});var a=t(96559),n=t(48088),i=t(37719),s=t(32190),d=t(13641),c=t(48719),u=t(82162),f=t(8516);async function l(e,{params:r}){try{let{id:e}=r,t=await d.db.gift.findUnique({where:{id:e},include:{memoryPhoto:{include:{gift:!0}}}});if(!t)return s.NextResponse.json({error:"Gift not found"},{status:404});return s.NextResponse.json(t)}catch(e){return console.error("Error fetching gift:",e),s.NextResponse.json({error:"Failed to fetch gift"},{status:500})}}async function p(e,{params:r}){try{let{id:t}=r,o=await e.json(),{title:a,author:n,nickname:i,openDate:u,number:l,englishDescription:p,hintImageUrl:E,imageCover:_,hintText:b,codeText:h,code:x,isSecret:m,content:w,memoryPhoto:A}=o,y=await d.db.gift.findUnique({where:{id:t},include:{memoryPhoto:!0}});if(!y)return s.NextResponse.json({error:"Gift not found"},{status:404});if(void 0!==l&&l!==y.number&&await d.db.gift.findFirst({where:{number:l,id:{not:t}}}))return s.NextResponse.json({error:"Gift with this number already exists"},{status:400});if(w){if(!await (0,c.z_)(t,w))return s.NextResponse.json({error:"Failed to save gift content"},{status:500});f._.YANDEX_ACCESS_KEY_ID&&f._.YANDEX_SECRET_ACCESS_KEY&&f._.YANDEX_BUCKET_NAME&&(o.contentUrl=`https://${f._.YANDEX_BUCKET_NAME}.storage.yandexcloud.net/${t}_content.json`)}await d.db.gift.update({where:{id:t},data:{...void 0!==a&&{title:a},...n&&{author:n},...i&&{nickname:i},...u&&{openDate:new Date(u)},...void 0!==l&&{number:l},...p&&{englishDescription:p},...E&&{hintImageUrl:E},...void 0!==_&&{imageCover:_},...b&&{hintText:b},...h&&{codeText:h},...void 0!==x&&{code:x},...void 0!==m&&{isSecret:m},...o.contentUrl&&{contentUrl:o.contentUrl}},include:{memoryPhoto:!0}}),void 0!==A&&(null===A?y.memoryPhoto&&await d.db.memoryPhoto.delete({where:{id:y.memoryPhoto.id}}):A.photoUrl&&(y.memoryPhoto?await d.db.memoryPhoto.update({where:{id:y.memoryPhoto.id},data:{photoUrl:A.photoUrl,...void 0!==A.photoDate&&{photoDate:A.photoDate?new Date(A.photoDate):null}}}):await d.db.memoryPhoto.create({data:{photoUrl:A.photoUrl,giftId:t,...void 0!==A.photoDate&&{photoDate:A.photoDate?new Date(A.photoDate):null}}})));let g=await d.db.gift.findUnique({where:{id:t},include:{memoryPhoto:{include:{gift:!0}}}});return s.NextResponse.json(g)}catch(e){return console.error("Error updating gift:",e),s.NextResponse.json({error:"Failed to update gift"},{status:500})}}async function E(e,{params:r}){try{let{id:e}=r;if(!await d.db.gift.findUnique({where:{id:e},include:{memoryPhoto:!0}}))return s.NextResponse.json({error:"Gift not found"},{status:404});if(await d.db.gift.delete({where:{id:e}}),f._.YANDEX_ACCESS_KEY_ID&&f._.YANDEX_SECRET_ACCESS_KEY&&f._.YANDEX_BUCKET_NAME)try{let r=await (0,u.zM)(e);console.log(`Удалено ${r} файлов из Yandex Object Storage для подарка ${e}`)}catch(r){console.error(`Ошибка удаления файлов из Yandex Object Storage для подарка ${e}:`,r)}return await (0,c.Tu)(e),s.NextResponse.json({success:!0})}catch(e){return console.error("Error deleting gift:",e),s.NextResponse.json({error:"Failed to delete gift"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/gifts/[id]/route",pathname:"/api/gifts/[id]",filename:"route",bundlePath:"app/api/gifts/[id]/route"},resolvedPagePath:"C:\\repositories\\lesya.svet\\src\\app\\api\\gifts\\[id]\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:b,workUnitAsyncStorage:h,serverHooks:x}=_;function m(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:h})}},48719:(e,r,t)=>{t.d(r,{Tu:()=>y,jJ:()=>m,or:()=>h,q2:()=>x,ql:()=>w,qr:()=>E,xK:()=>l,xZ:()=>A,ys:()=>p,z2:()=>b,z_:()=>_});var o=t(67218);t(79130);var a=t(29021),n=t(33873),i=t.n(n),s=t(82162),d=t(8516);let c=i().join(process.cwd(),"static","gifts");function u(e){return i().join(c,e)}function f(e){return i().join(u(e),"content.json")}let l=async function(e){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME){let r=await (0,s.yk)(e);if(r)return r}let r=f(e),t=await a.promises.readFile(r,"utf-8");return JSON.parse(t)}catch(r){return console.error(`Ошибка загрузки контента подарка: ${e}`,r),null}};var p=(0,o.A)(l,"406d5606aead8a8bacfe2cdd3e85cfdd2c19db2000",null);let E=async function(e,r){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME)try{return await (0,s.yz)(e,r),!0}catch(r){console.error(`Ошибка сохранения контента в Yandex Object Storage: ${e}`,r)}let t=u(e),o=f(e);return await a.promises.mkdir(t,{recursive:!0}),await a.promises.writeFile(o,JSON.stringify(r,null,2),"utf-8"),!0}catch(r){return console.error(`Ошибка сохранения контента подарка: ${e}`,r),!1}};var _=(0,o.A)(E,"60b232e31a3e4489582c571d7d7610ac8bf38a305a",null);let b=async function(e){return e};var h=(0,o.A)(b,"40dbb6530b043238ae6a08c39b3c8036d234882809",null);let x=async function(e){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME&&await (0,s.T1)(e))return!0;let r=f(e);return await a.promises.access(r),!0}catch{return!1}};(0,o.A)(x,"40ca065a4463e8263867e3e499283bc6b495df367f",null);let m=async function(e,r,t,o){try{if(d._.YANDEX_ACCESS_KEY_ID&&d._.YANDEX_SECRET_ACCESS_KEY&&d._.YANDEX_BUCKET_NAME)return await (0,s.TU)(t,r,e,o);throw Error("Yandex Object Storage is not configured")}catch(t){throw console.error(`Ошибка сохранения файла ${r} для подарка ${e}:`,t),t}};(0,o.A)(m,"78b96f14216dbd9b99266f83758b0d01a4b1b85f54",null);let w=async function(e,r){try{let t=r?i().join(u(e),r):u(e);return(await a.promises.readdir(t)).filter(e=>!e.startsWith("."))}catch(r){return console.error(`Ошибка получения файлов подарка ${e}:`,r),[]}};(0,o.A)(w,"600a0d7df77d62b52c417650c18d18495bacd7d9b8",null);let A=async function(e){try{let r=u(e);return await a.promises.rm(r,{recursive:!0,force:!0}),!0}catch(r){return console.error(`Ошибка удаления папки подарка ${e}:`,r),!1}};var y=(0,o.A)(A,"401a0502c0665f669338aad34b336a2135500fe412",null)},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{e.exports=require("timers")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},94735:e=>{e.exports=require("events")},95795:(e,r,t)=>{t.r(r),t.d(r,{"00ea83477a13a459fdf08fd3e6f65958e8233576fd":()=>a.xK,"401a0502c0665f669338aad34b336a2135500fe412":()=>o.xZ,"40217cf8d08e1947972106ddde22ddf43c2bb0ed41":()=>a.z2,"4066d672de5ab4d947483099099b587b8f65bca2a7":()=>a.q2,"406d0e21608895f9fa266a4fd00f7cd6825119033a":()=>a.EB,"406d5606aead8a8bacfe2cdd3e85cfdd2c19db2000":()=>o.xK,"4078492ea5b92d5fdfeed6743137880623145f68ac":()=>a.xZ,"40ca065a4463e8263867e3e499283bc6b495df367f":()=>o.q2,"40dbb6530b043238ae6a08c39b3c8036d234882809":()=>o.z2,"600a0d7df77d62b52c417650c18d18495bacd7d9b8":()=>o.ql,"60104488d5035fa6645db34d4720bc5db5ca51ebe3":()=>a.jJ,"6065a8450153a035b58e5f7c83c86ece5b2a923f4b":()=>a.ql,"60b232e31a3e4489582c571d7d7610ac8bf38a305a":()=>o.qr,"783346ae271af48396c519dd51d41fc3ec639e216f":()=>a.qr,"78b96f14216dbd9b99266f83758b0d01a4b1b85f54":()=>o.jJ});var o=t(48719),a=t(82162)},96330:e=>{e.exports=require("@prisma/client")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[447,724,267,580,41],()=>t(45576));module.exports=o})();